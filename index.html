<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capstone: AI Vision System</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background: #121212; color: white; margin: 0; padding: 20px; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 15px; display: inline-block; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #container { position: relative; display: none; margin-top: 20px; border: 3px solid #333; line-height: 0; }
        canvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; }
        img { width: 100%; max-width: 640px; height: auto; }
        input { padding: 10px; border-radius: 5px; border: none; width: 200px; }
        button { padding: 10px 20px; border-radius: 5px; border: none; background: #00ff88; color: #000; font-weight: bold; cursor: pointer; }
        .status { margin: 15px; color: #00ff88; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Capstone AI Scanner</h1>
    
    <div class="card" id="setup">
        <h3>Connect to Local Camera</h3>
        <p>Ensure you are on <b>Tenda_E6A990</b> WiFi</p>
        <input type="text" id="ipInput" value="192.168.0.100" placeholder="Enter ESP32 IP">
        <button onclick="initSystem()">Start System</button>
    </div>

    <div id="container">
        <img id="cam" crossorigin="anonymous">
        <canvas id="canvas"></canvas>
    </div>
    
    <div class="status" id="stat"></div>

    <script>
        const img = document.getElementById('cam');
        const stat = document.getElementById('stat');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let model;

        async function initSystem() {
            const ip = document.getElementById('ipInput').value;
            if(!ip) return alert("Please enter the IP address!");

            document.getElementById('setup').style.display = 'none';
            document.getElementById('container').style.display = 'inline-block';
            
            stat.innerText = "Loading AI Brain...";
            model = await cocoSsd.load();
            
            stat.innerText = "Connecting to Stream...";
            img.src = `http://${ip}/stream`;
            
            predict();
        }

        async function predict() {
            if (img.complete && img.naturalWidth > 0) {
                stat.innerText = "AI System Active";
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;

                const predictions = await model.detect(img);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                predictions.forEach(p => {
                    ctx.strokeStyle = "#00ff88";
                    ctx.lineWidth = 3;
                    ctx.strokeRect(...p.bbox);
                    ctx.fillStyle = "#00ff88";
                    ctx.font = "18px Arial";
                    ctx.fillText(`${p.class} (${Math.round(p.score*100)}%)`, p.bbox[0], p.bbox[1] > 10 ? p.bbox[1] - 5 : 10);
                });
            }
            requestAnimationFrame(predict);
        }
    </script>
</body>
</html>