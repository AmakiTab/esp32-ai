<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capstone: Edge Impulse AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #121212; color: white; margin: 0; padding: 20px; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 15px; display: inline-block; }
        #container { position: relative; display: none; margin-top: 20px; border: 3px solid #00ff88; }
        img { width: 100%; max-width: 400px; height: auto; }
        .status { margin: 15px; color: #00ff88; font-weight: bold; font-size: 1.2em; }
        .result-box { background: #333; padding: 10px; margin-top: 10px; border-radius: 8px; }
        input { padding: 10px; border-radius: 5px; border: none; }
        button { padding: 10px 20px; border-radius: 5px; border: none; background: #00ff88; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Custom Edge Impulse Vision</h1>
    
    <div class="card" id="setup">
        <h3>Connect to Local ESP32-CAM</h3>
        <input type="text" id="ipInput" value="192.168.0.100">
        <button onclick="initSystem()">Start Analysis</button>
    </div>

    <div id="container">
        <img id="cam" crossorigin="anonymous">
    </div>
    
    <div class="status" id="stat"></div>
    <div id="results" class="result-box" style="display:none;">
        <h3>Detection: <span id="label" style="color:#00ff88">---</span></h3>
        <p>Confidence: <span id="conf">0</span>%</p>
    </div>

    <script src="edge-impulse-standalone.js"></script>

<script>
    const img = document.getElementById('cam');
    const stat = document.getElementById('stat');
    const labelText = document.getElementById('label');
    const confText = document.getElementById('conf');
    
    let classifier;

    async function initSystem() {
        const ip = document.getElementById('ipInput').value;
        document.getElementById('setup').style.display = 'none';
        document.getElementById('container').style.display = 'inline-block';
        
        try {
            stat.innerText = "Initializing WASM Runner...";
            
            // This connects to the .js and .wasm files in your repo
            classifier = new EdgeImpulseClassifier();
            await classifier.init();
            
            stat.innerText = "Connecting to ESP32...";
            img.src = `http://${ip}/stream`;
            
            runInference();
        } catch (err) {
            stat.innerText = "WASM Error: " + err.message;
        }
    }

    async function runInference() {
        if (img.complete && img.naturalWidth > 0) {
            // Get image data from the stream
            const canvas = document.createElement('canvas');
            canvas.width = classifier.width;
            canvas.height = classifier.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // Run the Edge Impulse model
            const result = await classifier.classify(imageData.data);
            
            if (result.results.length > 0) {
                // Find the result with the highest score
                const top = result.results.reduce((prev, current) => 
                    (prev.value > current.value) ? prev : current);
                
                labelText.innerText = top.label;
                confText.innerText = Math.round(top.value * 100);
                stat.innerText = "System Active";
            }
        }
        requestAnimationFrame(runInference);
    }
</script>
